<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv='Content-type' content='text/html; charset=utf-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<title>Настройка сети</title>
	<link rel='stylesheet' href='style.css'>
</head>

<body>

<div id="container">
	<div id="part1">
		<ul id="menu">
			<li><div id="hamburger"><span class="hamburger"></span></div>
				<ul><li><a href="index.htm">Главная</a></li>
					<li><a href="setup.htm">Настройка сети</a></li>
					<li><a href="edit.htm">Файлы</a></li>
					<li><a href="update.htm">Обновление</a></li>
				</ul>
			</li>
		</ul>
	</div>
	<div id="part3">w</div>
	<div id="part2">Сетевые настройки</div>
</div>

<div class='content'>
	<h3>Настройка WiFi</h3>
	<h4><input type='radio' id='wifiAP_mode_off' name='wifiAP_mode' onchange='updateDisabledElements()'/> Режим клиента</h4>

	<p>Имя сети: <input type='text' id='p_ssid' maxlength='32' value=''/></p>
	<p>Пароль сети: <input type='text' id='p_password' maxlength='64' value=''/></p>
	
	<p><input type='checkbox' id='static_IP' onchange='updateDisabledElements()'>Статический IP-адрес:</p>

	<p>IP-адрес: <input type='text' id='ip_0' class='staticIP' size='3' maxlength='3' value=''/>
	:<input type='text' id='ip_1' class='staticIP' size='3' maxlength='3' value=''/>
	:<input type='text' id='ip_2' class='staticIP' size='3' maxlength='3' value=''/>
	:<input type='text' id='ip_3' class='staticIP' size='3' maxlength='3' value=''/>
	</p>

	<p>Маска подсети: <input type='text' id='sbnt_0' class='staticIP' size='3' maxlength='3' value=''/>
	:<input type='text' id='sbnt_1' class='staticIP' size='3' maxlength='3' value=''/>
	:<input type='text' id='sbnt_2' class='staticIP' size='3' maxlength='3' value=''/>
	:<input type='text' id='sbnt_3' class='staticIP' size='3' maxlength='3' value=''/>
	</p>

	<p>Основной шлюз: <input type='text' id='gtw_0' class='staticIP' size='3' maxlength='3' value=''/>
	:<input type='text' id='gtw_1' class='staticIP' size='3' maxlength='3' value=''/>
	:<input type='text' id='gtw_2' class='staticIP' size='3' maxlength='3' value=''/>
	:<input type='text' id='gtw_3' class='staticIP' size='3' maxlength='3' value=''/>
	</p>

	<hr>
	<h4><input type='radio' id='wifiAP_mode_on' name='wifiAP_mode' onchange='updateDisabledElements()'/> Режим точки доступа</h4>

	<p>Имя сети: <input type='text' id='p_ssidAP' maxlength='32' value=''/></p>
	<p>Пароль сети: <input type='text' id='p_passwordAP' maxlength='64' value=''/></p>

	<hr>
	<p><button onclick="sendData()">Сохранить</button></p>
	<p><button onclick="sendReset()">Перезагрузить</button></p>
	<p><button onclick="sendResetStat()">Сброс статистики</button></p>
</div>

<script>
	let data = {
		page: "setup",
		ip: new Array(),
		sbnt: new Array(),
		gtw: new Array(),
		p_ssid: "",
		p_password: "",
		p_ssidAP: "",
		p_passwordAP: "",
		wifiAP_mode: 0,
		static_IP: false
	};


	function updateAllData() {
		data["static_IP"] = document.getElementById("static_IP").checked;
		data["ip"][0] = (document.getElementById('ip_0').value);
		data["ip"][1] = (document.getElementById('ip_1').value);
		data["ip"][2] = (document.getElementById('ip_2').value);
		data["ip"][3] = (document.getElementById('ip_3').value);
		data["sbnt"][0] = (document.getElementById('sbnt_0').value);
		data["sbnt"][1] = (document.getElementById('sbnt_1').value);
		data["sbnt"][2] = (document.getElementById('sbnt_2').value);
		data["sbnt"][3] = (document.getElementById('sbnt_3').value);
		data["gtw"][0] = (document.getElementById('gtw_0').value);
		data["gtw"][1] = (document.getElementById('gtw_1').value);
		data["gtw"][2] = (document.getElementById('gtw_2').value);
		data["gtw"][3] = (document.getElementById('gtw_3').value);
		data["p_ssid"] = document.getElementById("p_ssid").value;
		data["p_password"] = document.getElementById("p_password").value;
		data["p_ssidAP"] = document.getElementById("p_ssidAP").value;
		data["p_passwordAP"] = document.getElementById("p_passwordAP").value;
		if (document.getElementById('wifiAP_mode_on').checked == true)   data["wifiAP_mode"] = true;
		else  data["wifiAP_mode"] = false;
	};


	function updateAllPage() {
		document.getElementById('static_IP').checked = data["static_IP"];
		document.getElementById('ip_0').value = data["ip"][0];
		document.getElementById('ip_1').value = data["ip"][1]; 
		document.getElementById('ip_2').value = data["ip"][2]; 
		document.getElementById('ip_3').value = data["ip"][3];
		document.getElementById('sbnt_0').value = data["sbnt"][0];
		document.getElementById('sbnt_1').value = data["sbnt"][1];
		document.getElementById('sbnt_2').value = data["sbnt"][2];
		document.getElementById('sbnt_3').value = data["sbnt"][3];
		document.getElementById('gtw_0').value = data["gtw"][0];
		document.getElementById('gtw_1').value = data["gtw"][1]; 
		document.getElementById('gtw_2').value = data["gtw"][2]; 
		document.getElementById('gtw_3').value = data["gtw"][3];
		if (data["wifiAP_mode"]==true) {
			document.getElementById('wifiAP_mode_on').checked = true;
			document.getElementById('wifiAP_mode_off').checked = false;
		} else {
			document.getElementById('wifiAP_mode_on').checked = false;
			document.getElementById('wifiAP_mode_off').checked = true;	
		}
		document.getElementById('p_ssid').value = data["p_ssid"];
		document.getElementById('p_password').value = data["p_password"];
		document.getElementById('p_ssidAP').value = data["p_ssidAP"];
		document.getElementById('p_passwordAP').value = data["p_passwordAP"];
	};

	function sendData () {
		updateAllData();
		console.log('TO Server: ', JSON.stringify( data ));
		connection.send(JSON.stringify( data ));
	};

	function sendReset () {
		if (confirm("Вы хотите перезагрузить устройство?")) {
			let msg = 'RESET';
			console.log('TO Server: ', msg);
			connection.send(msg);
		}
	};

	function sendResetStat () {
		if (confirm("Вы подтверждаете сброс статистики? После сброса информацию невозможно будет восстановить")) {
			let msg = 'RESET_STAT';
			console.log('TO Server: ', msg);
			connection.send(msg);
		}
	};


	let wsAdress = 'ws://' + location.host + ':81/setup.htm';
	//let wsAdress = 'ws://192.168.43.43:81/setup.htm';
	let connection = new WebSocket(wsAdress, ['arduino']);
	console.log(connection);
	
	connection.onopen = function () {
		//connection.send('ping');
	};

	connection.onerror = function (error) {
		console.log('WebSocket Error ', error);
		alert("Ошибка " + error.message);
	};

	connection.onmessage = function (e) {
		console.log('FROM Server: ', e.data);
		let obj = JSON.parse(e.data);
		for (x in obj) {
			if ( data[x]  != null ) {
				data[x] = obj[x];
				switch (x) {
					case 'wifiAP_mode':
						if (data[x]==true) {
							document.getElementById('wifiAP_mode_on').checked = true;
							document.getElementById('wifiAP_mode_off').checked = false;
						} else {
							document.getElementById('wifiAP_mode_on').checked = false;
							document.getElementById('wifiAP_mode_off').checked = true;	
						}
						break;
					case 'ip':
						document.getElementById('ip_0').value = data[x][0];
						document.getElementById('ip_1').value = data[x][1]; 
						document.getElementById('ip_2').value = data[x][2]; 
						document.getElementById('ip_3').value = data[x][3];
						break;
					case 'sbnt':
						document.getElementById('sbnt_0').value = data[x][0];
						document.getElementById('sbnt_1').value = data[x][1]; 
						document.getElementById('sbnt_2').value = data[x][2]; 
						document.getElementById('sbnt_3').value = data[x][3];
						break;
					case 'gtw':
						document.getElementById('gtw_0').value = data[x][0];
						document.getElementById('gtw_1').value = data[x][1]; 
						document.getElementById('gtw_2').value = data[x][2]; 
						document.getElementById('gtw_3').value = data[x][3];
						break;
					case 'static_IP':
						document.getElementById('static_IP').checked = obj[x];
						break;
					default:
						document.getElementById(x).value = obj[x];
				}
			}
		}
		updateDisabledElements();
		document.getElementById("part3").classList.toggle("part3A");
	};


	function updateDisabledElements() {
		var elements = document.getElementsByClassName("staticIP");
		for (let n=0; n<elements.length; n++){
			if (document.getElementById("static_IP").checked){
				elements[n].removeAttribute("disabled");
			}else{
				elements[n].setAttribute("disabled", "true");
			}
		}
		if (document.getElementById('wifiAP_mode_on').checked){
			document.getElementById('p_ssid').setAttribute("disabled", "true");
			document.getElementById('p_password').setAttribute("disabled", "true");
			document.getElementById('p_ssidAP').removeAttribute("disabled");
			document.getElementById('p_passwordAP').removeAttribute("disabled");
		}else{
			document.getElementById('p_ssid').removeAttribute("disabled");
			document.getElementById('p_password').removeAttribute("disabled");
			document.getElementById('p_ssidAP').setAttribute("disabled", "true");
			document.getElementById('p_passwordAP').setAttribute("disabled", "true");
		}
	}


</script>

</body>
</html>